name: TeamCity-Style CI/CD with Summary

on:
  push: # Runs tests + linting automatically
    branches:
      - main
      - develop
  workflow_dispatch: # Manual deployment
    inputs:
      environment:
        description: "Deployment Environment"
        required: true
        type: choice
        default: "staging"
        options:
          - staging
          - production
      version:
        description: "Version (leave blank for auto)"
        required: false
        default: ""
      artifact:
        description: "Artifact(s) to deploy (comma separated)"
        required: true
        default: "all"
      dry_run:
        description: "Dry Run (skip actual deployment)"
        type: boolean
        default: false

jobs:
  # 🔍 Auto Test & Lint on Push
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - name: Run Linter
        run: echo "Running linter..."

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - name: Run Tests
        run: echo "Running tests..."

  # ⚡ Manual Deploy
  set_version:
    name: Set Version
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    outputs:
      version: ${{ steps.version_output.outputs.version }}
    steps:
      - name: Determine Version
        id: version_output
        run: |
            VERSION_INPUT="${{ github.event.inputs.version }}"
            if [ -z "$VERSION_INPUT" ]; then
            AUTO_VERSION="v$(date +'%Y.%m.%d')-${GITHUB_RUN_NUMBER}"
            echo "Auto-generated version: $AUTO_VERSION"
            echo "version=$AUTO_VERSION" >> $GITHUB_OUTPUT
            else
            echo "version=$VERSION_INPUT" >> $GITHUB_OUTPUT
            fi

      - name: Create Build Summary
        run: |
          echo "## 📝 Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version_output.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact(s) | ${{ github.event.inputs.artifact }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ github.event.inputs.dry_run }} |" >> $GITHUB_STEP_SUMMARY

  approve_production:
    name: Approval Gate (Production)
    runs-on: ubuntu-latest
    needs: set_version
    if: ${{ github.event.inputs.environment == 'production' }}
    steps:
        - name: Await Manual Approval
          run: echo "Manual approval before deploying to production..."

  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: [set_version, approve_production]
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - name: Deploy
        run: |
          echo "Deploying version ${{ needs.set_version.outputs.version }} to ${{ github.event.inputs.environment }}"
          echo "Deploying artifact(s): ${{ github.event.inputs.artifact }}"
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "Dry run: no deployment executed."
          else
            echo "Deployment complete."
